name: Nifty Trading Analyzer + GitHub Pages

on:
  schedule:
    - cron: '45 3 * * 1-5'
    - cron: '30 6 * * 1-5'
    - cron: '30 9 * * 1-5'
  workflow_dispatch:
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pages: write
  id-token: write

env:
  PYTHON_VERSION: '3.10'

jobs:
  analyze-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance requests beautifulsoup4 pyyaml
          fi
          pip list

      - name: Create config.yml
        run: |
          cat > config.yml << 'CONFIG_EOF'
          email:
            recipient: "${{ secrets.RECIPIENT_EMAIL }}"
            sender: "${{ secrets.SENDER_EMAIL }}"
            app_password: "${{ secrets.EMAIL_APP_PASSWORD }}"
            subject_prefix: "Nifty Trading Alert"
            send_on_failure: false
          
          technical:
            timeframe: "1h"
            period: "6mo"
            rsi_period: 14
            rsi_overbought: 70
            rsi_oversold: 30
            ema_short: 20
            ema_long: 50
            num_support_levels: 2
            num_resistance_levels: 2
          
          option_chain:
            pcr_bullish: 1.0
            pcr_very_bullish: 1.2
            pcr_bearish: 1.0
            pcr_very_bearish: 0.8
            strike_range: 500
            min_oi: 100000
          
          recommendation:
            strong_buy_threshold: 3
            buy_threshold: 1
            sell_threshold: -1
            strong_sell_threshold: -3
          
          report:
            title: "NIFTY DAY TRADING ANALYSIS"
            save_local: true
            local_dir: "./reports"
            filename_format: "nifty_analysis_%Y%m%d_%H%M%S.html"
            colors:
              strong_buy: "#28a745"
              buy: "#5cb85c"
              neutral: "#ffc107"
              sell: "#f0ad4e"
              strong_sell: "#dc3545"
          
          data_source:
            option_chain_source: "nse"
            technical_source: "yahoo"
            max_retries: 3
            retry_delay: 2
            timeout: 10
            fallback_to_sample: true
          
          logging:
            level: "INFO"
            log_to_file: true
            log_file: "./logs/nifty_analyzer.log"
            format: "%(asctime)s - %(levelname)s - %(message)s"
          
          advanced:
            verbose: true
            debug: false
            validate_data: true
            min_data_points: 100
          CONFIG_EOF

      - name: Create directories
        run: |
          mkdir -p reports logs

      - name: Run Analysis Script
        run: |
          if [ -f "nifty_analyzer_with_yaml.py" ]; then
            python nifty_analyzer_with_yaml.py
          elif [ -f "nifty_trading_analyzer.py" ]; then
            python nifty_trading_analyzer.py
          else
            echo "ERROR: Python script not found!"
            ls -la *.py
            exit 1
          fi
        continue-on-error: true

      - name: Prepare GitHub Pages site
        run: |
          mkdir -p public
          latest_report=$(ls -t reports/*.html 2>/dev/null | head -n 1 || echo "")
          if [ -n "$latest_report" ]; then
            cp "$latest_report" public/index.html
          else
            echo "<html><body><h2>No report generated</h2></body></html>" > public/index.html
          fi

      - name: Upload GitHub Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Upload Reports as Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nifty-reports-${{ github.run_number }}
          path: reports/*.html
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyzer-logs-${{ github.run_number }}
          path: logs/*.log
          if-no-files-found: warn
          retention-days: 7
