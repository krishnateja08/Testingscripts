name: Nifty Trading Analyzer

# Workflow triggers
on:
  # Run on schedule (cron format in UTC)
  schedule:
    # Run at 3:45 AM UTC (9:15 AM IST) - Market Open
    - cron: '45 3 * * 1-5'
    # Run at 6:30 AM UTC (12:00 PM IST) - Mid-day
    - cron: '30 6 * * 1-5'
    # Run at 9:30 AM UTC (3:00 PM IST) - Before Market Close
    - cron: '30 9 * * 1-5'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
  
  # Run on push to main branch (for testing)
  push:
    branches:
      - main
      - master
    paths:
      - '**.py'
      - '**.yml'
      - '**.yaml'
      - 'requirements.txt'

# Environment variables
env:
  PYTHON_VERSION: '3.10'

jobs:
  analyze:
    name: Run Nifty Analysis
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      # Step 2: List files (debugging)
      - name: List repository files
        run: |
          echo "=== Repository Contents ==="
          ls -la
          echo "=== Looking for Python files ==="
          find . -name "*.py" -type f
          echo "=== Looking for requirements.txt ==="
          find . -name "requirements.txt" -type f
      
      # Step 3: Set up Python
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      # Step 4: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Check if requirements.txt exists
          if [ -f "requirements.txt" ]; then
            echo "Installing from requirements.txt"
            pip install -r requirements.txt
          else
            echo "requirements.txt not found, installing packages directly"
            pip install pandas>=1.5.0
            pip install numpy>=1.23.0
            pip install yfinance>=0.2.0
            pip install requests>=2.28.0
            pip install beautifulsoup4>=4.11.0
            pip install pyyaml>=6.0
          fi
          
          echo "=== Installed packages ==="
          pip list
      
      # Step 5: Create config from secrets
      - name: Configure analyzer settings
        run: |
          # Create config.yml from secrets
          cat > config.yml << 'EOF'
          email:
            recipient: "${{ secrets.RECIPIENT_EMAIL }}"
            sender: "${{ secrets.SENDER_EMAIL }}"
            app_password: "${{ secrets.EMAIL_APP_PASSWORD }}"
            subject_prefix: "Nifty Trading Alert"
            send_on_failure: false
          
          technical:
            timeframe: "${{ vars.TIMEFRAME || '1h' }}"
            period: "${{ vars.PERIOD || '6mo' }}"
            rsi_period: ${{ vars.RSI_PERIOD || 14 }}
            rsi_overbought: ${{ vars.RSI_OVERBOUGHT || 70 }}
            rsi_oversold: ${{ vars.RSI_OVERSOLD || 30 }}
            ema_short: ${{ vars.EMA_SHORT || 20 }}
            ema_long: ${{ vars.EMA_LONG || 50 }}
            num_support_levels: 2
            num_resistance_levels: 2
          
          option_chain:
            pcr_bullish: 1.0
            pcr_very_bullish: 1.2
            pcr_bearish: 1.0
            pcr_very_bearish: 0.8
            strike_range: 500
            min_oi: 100000
          
          recommendation:
            strong_buy_threshold: 3
            buy_threshold: 1
            sell_threshold: -1
            strong_sell_threshold: -3
          
          report:
            title: "NIFTY DAY TRADING ANALYSIS"
            save_local: true
            local_dir: "./reports"
            filename_format: "nifty_analysis_%Y%m%d_%H%M%S.html"
            colors:
              strong_buy: "#28a745"
              buy: "#5cb85c"
              neutral: "#ffc107"
              sell: "#f0ad4e"
              strong_sell: "#dc3545"
          
          data_source:
            option_chain_source: "nse"
            technical_source: "yahoo"
            max_retries: 3
            retry_delay: 2
            timeout: 10
            fallback_to_sample: true
          
          logging:
            level: "INFO"
            log_to_file: true
            log_file: "./logs/nifty_analyzer.log"
            format: "%(asctime)s - %(levelname)s - %(message)s"
          
          advanced:
            verbose: true
            debug: false
            validate_data: true
            min_data_points: 100
          EOF
          
          echo "=== Config file created ==="
          cat config.yml
      
      # Step 6: Create necessary directories
      - name: Create directories
        run: |
          mkdir -p reports
          mkdir -p logs
          echo "=== Directories created ==="
          ls -la
      
      # Step 7: Find and run the analyzer
      - name: Run Nifty Analysis
        run: |
          # Find the Python script
          if [ -f "nifty_analyzer_with_yaml.py" ]; then
            echo "Running nifty_analyzer_with_yaml.py"
            python nifty_analyzer_with_yaml.py
          elif [ -f "nifty_trading_analyzer.py" ]; then
            echo "Running nifty_trading_analyzer.py"
            python nifty_trading_analyzer.py
          else
            echo "ERROR: No analyzer script found!"
            echo "Available Python files:"
            find . -name "*.py" -type f
            exit 1
          fi
        continue-on-error: true
      
      # Step 8: Check for generated reports
      - name: Check generated files
        if: always()
        run: |
          echo "=== Reports directory ==="
          ls -la reports/ || echo "No reports directory"
          echo "=== Logs directory ==="
          ls -la logs/ || echo "No logs directory"
          echo "=== Root directory ==="
          ls -la *.html || echo "No HTML files in root"
      
      # Step 9: Upload reports as artifacts
      - name: Upload HTML Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nifty-report-${{ github.run_number }}
          path: |
            reports/*.html
            *.html
          if-no-files-found: warn
          retention-days: 30
      
      # Step 10: Upload logs
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analyzer-logs-${{ github.run_number }}
          path: |
            logs/*.log
            *.log
          if-no-files-found: warn
          retention-days: 7
      
      # Step 11: Display log contents (for debugging)
      - name: Display logs
        if: always()
        run: |
          echo "=== Analyzer Logs ==="
          if [ -f "logs/nifty_analyzer.log" ]; then
            cat logs/nifty_analyzer.log
          else
            echo "No log file found"
          fi
      
      # Step 12: Send notification on failure (optional)
      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Analysis failed. Check the logs for details."
          echo "Common issues:"
          echo "1. Missing requirements.txt - Install packages directly"
          echo "2. Missing Python script - Upload nifty_analyzer_with_yaml.py"
          echo "3. NSE API blocking - Set fallback_to_sample: true"
          echo "4. Email credentials - Check GitHub secrets"
